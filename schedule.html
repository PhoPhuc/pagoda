<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Tạo Lịch Trình Du Lịch AI - Chùa Tân Hồng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
        }
        .step { display: none; }
        .step.active { display: block; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        
        /* Custom Checkbox/Radio for Soft Design */
        .custom-choice input { display: none; }
        .custom-choice label {
            cursor: pointer;
            display: block;
            text-align: center;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: 1px solid #e5e7eb; /* border-gray-200 */
            background: #f9fafb; /* bg-gray-50 */
            color: #374151; /* text-gray-700 */
            transition: all 0.2s ease-in-out;
        }
        .custom-choice input:checked + label {
            background: #4f46e5; /* bg-indigo-600 */
            color: white;
            border-color: #4f46e5; /* border-indigo-600 */
            font-weight: 600;
        }
        .custom-choice label:hover {
            border-color: #a5b4fc; /* border-indigo-300 */
        }

        .loader {
            border: 4px solid #e5e7eb; /* border-gray-200 */
            border-radius: 50%;
            border-top: 4px solid #4f46e5; /* border-indigo-600 */
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Timeline styles for Soft Design */
        .timeline {
            position: relative;
            padding-left: 3rem;
            margin: 1rem 0;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 1.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb; /* bg-gray-200 */
            transform: translateX(-50%);
        }
        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
        }
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        .timeline-icon {
            position: absolute;
            left: -1.5rem;
            top: 0;
            transform: translateX(-50%);
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl mx-auto">
        <div id="app-container" class="bg-white text-gray-800 p-6 md:p-10 rounded-2xl shadow-xl">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold mb-2 text-gray-900">Tạo Lịch Trình Du Lịch Tân Hồng</h1>
                <p class="text-gray-500">Cùng A.I lên kế hoạch cho chuyến đi hoàn hảo của bạn!</p>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-8">
                <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full progress-bar-fill" style="width: 20%"></div>
            </div>

            <!-- Steps Container -->
            <div id="steps-container">
                 <!-- Step 1: Select Temples -->
                <div id="step-1" class="step active">
                    <h2 class="text-2xl font-semibold mb-6 text-center">Bước 1: Bạn muốn viếng chùa nào?</h2>
                    <div class="grid grid-cols-2 gap-4 custom-choice">
                        <div><input type="checkbox" id="don-hau" value="Chùa Đôn Hậu" class="temple-checkbox"><label for="don-hau">Chùa Đôn Hậu</label></div>
                        <div><input type="checkbox" id="dong-an" value="Chùa Đông An" class="temple-checkbox"><label for="dong-an">Chùa Đông An</label></div>
                        <div><input type="checkbox" id="phuoc-thien" value="Chùa Phước Thiện" class="temple-checkbox"><label for="phuoc-thien">Chùa Phước Thiện</label></div>
                        <div><input type="checkbox" id="hieu-duc" value="Chùa Hiếu Đức" class="temple-checkbox"><label for="hieu-duc">Chùa Hiếu Đức</label></div>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button onclick="nextStep(2)" class="rounded-xl transition duration-300 transform hover:scale-105 bg-indigo-600 text-white font-semibold py-3 px-8 shadow-lg hover:shadow-indigo-400/50">Tiếp tục</button>
                    </div>
                </div>
                <!-- Step 2: Select Time Frame -->
                <div id="step-2" class="step">
                    <h2 class="text-2xl font-semibold mb-6 text-center">Bước 2: Chọn khung thời gian đi</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="start-time" class="font-medium text-gray-700">Thời gian bắt đầu</label>
                            <select id="start-time" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="end-time" class="font-medium text-gray-700">Thời gian kết thúc</label>
                            <select id="end-time" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-between">
                        <button onclick="prevStep(1)" class="rounded-xl transition duration-300 hover:bg-gray-300 bg-gray-200 text-gray-700 font-semibold py-3 px-8">Quay lại</button>
                        <button onclick="nextStep(3)" class="rounded-xl transition duration-300 transform hover:scale-105 bg-indigo-600 text-white font-semibold py-3 px-8 shadow-lg hover:shadow-indigo-400/50">Tiếp tục</button>
                    </div>
                </div>
                 <!-- Step 3: Group Details -->
                <div id="step-3" class="step">
                    <h2 class="text-2xl font-semibold mb-6 text-center">Bước 3: Đặc điểm nhóm của bạn là gì?</h2>
                    <div class="custom-choice">
                         <div class="grid grid-cols-2 gap-4">
                            <div><input type="radio" id="audience-friends" name="audience" value="Nhóm bạn trẻ" checked><label for="audience-friends">Bạn bè</label></div>
                            <div><input type="radio" id="audience-family" name="audience" value="Gia đình có trẻ em"><label for="audience-family">Gia đình</label></div>
                            <div><input type="radio" id="audience-elderly" name="audience" value="Nhóm có người lớn tuổi"><label for="audience-elderly">Có người lớn tuổi</label></div>
                            <div><input type="radio" id="audience-solo" name="audience" value="Đi một mình"><label for="audience-solo">Một mình</label></div>
                         </div>
                    </div>
                     <div class="mt-8 flex justify-between">
                        <button onclick="prevStep(2)" class="rounded-xl transition duration-300 hover:bg-gray-300 bg-gray-200 text-gray-700 font-semibold py-3 px-8">Quay lại</button>
                        <button onclick="nextStep(4)" class="rounded-xl transition duration-300 transform hover:scale-105 bg-indigo-600 text-white font-semibold py-3 px-8 shadow-lg hover:shadow-indigo-400/50">Tiếp tục</button>
                    </div>
                </div>
                <!-- Step 4: Select Preferences -->
                <div id="step-4" class="step">
                    <h2 class="text-2xl font-semibold mb-6 text-center">Bước 4: Yêu cầu thêm của bạn?</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 custom-choice">
                        <div><input type="checkbox" id="pref-food" class="preference-checkbox"><label for="pref-food">Ăn uống</label></div>
                        <div><input type="checkbox" id="pref-drink" class="preference-checkbox"><label for="pref-drink">Giải khát</label></div>
                        <div><input type="checkbox" id="pref-stay" class="preference-checkbox"><label for="pref-stay">Nghỉ lại</label></div>
                    </div>
                    <div class="mt-8 flex justify-between">
                        <button onclick="prevStep(3)" class="rounded-xl transition duration-300 hover:bg-gray-300 bg-gray-200 text-gray-700 font-semibold py-3 px-8">Quay lại</button>
                        <button onclick="generateItinerary()" class="rounded-xl transition duration-300 transform hover:scale-105 bg-indigo-600 text-white font-semibold py-3 px-8 shadow-lg hover:shadow-indigo-400/50">Tạo Lịch Trình</button>
                    </div>
                </div>

                <!-- Step 5: Result -->
                <div id="step-5" class="step">
                    <h2 class="text-2xl font-semibold mb-6 text-center">Lịch trình gợi ý</h2>
                    <div id="loading" class="flex justify-center items-center my-8 hidden">
                       <div class="loader"></div>
                    </div>
                    <div id="itinerary-output" class="bg-gray-50 p-6 rounded-lg min-h-[200px] border border-gray-200">
                        <div id="itinerary-result"></div>
                    </div>
                    <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                        <button onclick="captureSchedule()" class="rounded-xl transition duration-300 hover:bg-gray-300 bg-gray-200 text-gray-800 font-semibold py-3 px-8 flex items-center justify-center gap-2">
                            <i data-lucide="camera"></i> Chụp ảnh Lịch trình
                        </button>
                        <button onclick="startOver()" class="rounded-xl transition duration-300 transform hover:scale-105 bg-indigo-600 text-white font-semibold py-3 px-8 shadow-lg hover:shadow-indigo-400/50">Tạo lịch trình mới</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    let currentStep = 1;
    const totalSteps = 5;

    function updateProgressBar() {
        const progressBar = document.getElementById('progress-bar');
        const progress = (currentStep / totalSteps) * 100;
        progressBar.style.width = `${progress}%`;
    }

    function showStep(stepNumber) {
        document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
        document.getElementById(`step-${stepNumber}`).classList.add('active');
        currentStep = stepNumber;
        updateProgressBar();
        lucide.createIcons(); // Re-render icons on step change
    }

    function nextStep(stepNumber) {
        if (currentStep === 1 && document.querySelectorAll('.temple-checkbox:checked').length === 0) {
            alert('Vui lòng chọn ít nhất một ngôi chùa.');
            return;
        }
        if (currentStep === 2) {
            const startTime = parseInt(document.getElementById('start-time').value);
            const endTime = parseInt(document.getElementById('end-time').value);
            if (startTime >= endTime) {
                alert('Thời gian kết thúc phải sau thời gian bắt đầu.');
                return;
            }
        }
        showStep(stepNumber);
    }
    
    function prevStep(stepNumber) { showStep(stepNumber); }

    function startOver() {
        // Reset all inputs to default state
        document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
        document.getElementById('start-time').value = '7';
        document.getElementById('end-time').value = '17';
        document.getElementById('audience-friends').checked = true;
        
        document.getElementById('itinerary-result').innerHTML = '';
        showStep(1);
    }
    
    function getIconForActivity(activity) {
        const lowerActivity = activity.toLowerCase();
        if (lowerActivity.includes('chùa') || lowerActivity.includes('viếng')) return 'church';
        if (lowerActivity.includes('ăn') || lowerActivity.includes('dùng bữa')) return 'utensils-crossed';
        if (lowerActivity.includes('cà phê') || lowerActivity.includes('giải khát') || lowerActivity.includes('nước')) return 'coffee';
        if (lowerActivity.includes('nhận phòng') || lowerActivity.includes('nghỉ')) return 'bed-double';
        if (lowerActivity.includes('khởi hành') || lowerActivity.includes('di chuyển')) return 'car';
        if (lowerActivity.includes('kết thúc')) return 'flag';
        return 'map-pin';
    }

    function parseAndRenderItinerary(text) {
        const resultDiv = document.getElementById('itinerary-result');
        resultDiv.innerHTML = ''; // Clear previous results
        const timeline = document.createElement('div');
        timeline.className = 'timeline';

        const lines = text.split('\n').filter(line => line.trim() !== '');
        lines.forEach(line => {
            const parts = line.split(' - ');
            if (parts.length < 2) return;
            const timeAndEmojiPart = parts[0];
            const restOfString = parts.slice(1).join(' - ').trim();
            const timeMatch = timeAndEmojiPart.match(/(\*\*.*?\*\*|`.*?`)/);
            if (!timeMatch) return;
            const timeRaw = timeMatch[0];
            const time = timeRaw.replace(/[\*`]/g, '');
            const emoji = timeAndEmojiPart.replace(timeRaw, '').trim();
            
            let activity = restOfString;
            let locationName = null;
            let locationAddress = null;

            const fullLocationMatch = restOfString.match(/(.*?)\s+tại\s+\[\[(.*?)\s*-\s*(.*?)\]\]\.?$/);
            const simpleLocationMatch = restOfString.match(/(.*?)\s+tại\s+\[\[(.*?)\]\]\.?$/);

            if (fullLocationMatch) {
                activity = fullLocationMatch[1].trim();
                locationName = fullLocationMatch[2].trim();
                locationAddress = fullLocationMatch[3].trim();
            } else if (simpleLocationMatch) {
                activity = simpleLocationMatch[1].trim();
                locationName = simpleLocationMatch[2].trim();
            } else {
                if (activity.endsWith('.')) {
                    activity = activity.slice(0, -1);
                }
            }
            if (!activity) return;

            // Apply formatting for italics and underline
            activity = activity
                .replace(/\*(.*?)\*/g, '<i>$1</i>')
                .replace(/\_(.*?)\_/g, '<u>$1</u>');

            const iconName = getIconForActivity(activity);
            const item = document.createElement('div');
            item.className = 'timeline-item';
            
            let locationHtml = '';
            if (locationName) {
                const mapQuery = locationAddress ? `${locationName}, ${locationAddress}` : `${locationName}, Tân Hồng, Đồng Tháp`;
                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapQuery)}`;
                const addressHtml = locationAddress ? `<span class="text-xs text-gray-500 block">${locationAddress}</span>` : '';
                
                locationHtml = `
                    <a href="${mapUrl}" target="_blank" class="block group mt-2">
                        <div class="flex items-start gap-2">
                             <i data-lucide="map-pin" class="w-4 h-4 flex-shrink-0 mt-1 text-gray-400 group-hover:text-indigo-600"></i>
                             <div>
                                <span class="font-medium text-indigo-600 group-hover:underline">${locationName}</span>
                                ${addressHtml}
                             </div>
                        </div>
                    </a>`;
            }
            
            item.innerHTML = `
                <div class="timeline-icon"><i data-lucide="${iconName}"></i></div>
                <div class="timeline-content">
                    <p class="font-semibold text-indigo-600">${time}</p>
                    <p class="font-bold text-lg text-gray-800">${emoji} ${activity}</p>
                    ${locationHtml}
                </div>`;
            timeline.appendChild(item);
        });

        resultDiv.appendChild(timeline);
        lucide.createIcons();
    }
    
    function captureSchedule() {
        const scheduleElement = document.getElementById('itinerary-output');
        if (!scheduleElement || scheduleElement.innerText.trim() === '') {
            alert('Không có lịch trình để chụp ảnh.');
            return;
        }
        html2canvas(scheduleElement, { 
            backgroundColor: '#f9fafb',
            scale: 2 
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'lich-trinh-du-lich-tan-hong.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }

    async function generateItinerary() {
        showStep(5);
        const loadingDiv = document.getElementById('loading');
        const resultDiv = document.getElementById('itinerary-result');
        loadingDiv.classList.remove('hidden');
        resultDiv.innerHTML = '';

        const selectedTemples = Array.from(document.querySelectorAll('.temple-checkbox:checked')).map(cb => cb.value);
        const startTime = document.getElementById('start-time').value + ':00';
        const endTime = document.getElementById('end-time').value + ':00';
        const audience = document.querySelector('input[name="audience"]:checked').value;
        const includeFood = document.getElementById('pref-food').checked;
        const includeDrink = document.getElementById('pref-drink').checked;
        const includeStay = document.getElementById('pref-stay').checked;

        let prompt = `Bạn là một trợ lý du lịch chuyên nghiệp tại huyện Tân Hồng, Đồng Tháp. Hãy tạo một lịch trình du lịch ngắn gọn, hợp lý và dễ hiểu theo các yêu cầu sau:\n\n`;
        
        prompt += `DỮ LIỆU BẮT BUỘC SỬ DỤNG:\n`;
        prompt += `- Điểm xuất phát MẶC ĐỊNH: Trung tâm thị trấn Sa Rài, Tân Hồng, Đồng Tháp.\n`;
        prompt += `- Dữ liệu địa chỉ chùa CHÍNH XÁC (sử dụng đúng địa chỉ này):\n`;
        prompt += `  - Chùa Đôn Hậu: Bình Phú, Tân Hồng, Đồng Tháp\n`;
        prompt += `  - Chùa Phước Thiện: Công Tạo, Bình Phú, Tân Hồng, Đồng Tháp\n`;
        prompt += `  - Chùa Đông An: Tân Hộ Cơ, Tân Hồng, Đồng Tháp\n`;
        prompt += `  - Chùa Hiếu Đức: Tân Hộ Cơ, Tân Hồng, Đồng Tháp\n`;
        prompt += `- DANH SÁCH QUÁN ĂN/CÀ PHÊ (ƯU TIÊN CHỌN TỪ ĐÂY):\n`;
        prompt += `  - Cơm tâm đêm Bảo Xuyên: Nguyễn Huệ, TT. Sa Rài, H. Tân Hồng, Đồng Tháp\n`;
        prompt += `  - Phở Tám Hơn: TT. Sa Rài, Tân Hồng, Đồng Tháp\n`;
        prompt += `  - Mì Quảng Giáo Lượng: Nguyễn Huệ, TT. Sa Rài\n`;
        prompt += `  - Bún riêu Cua Đồng: Đường Tỉnh 843, TT. Sa Rài\n`;
        prompt += `  - Hủ tiếu Nam Vang Huỳnh Ký: QL30, TT. Sa Rài\n`;
        prompt += `  - Bún bò Huế O Cúc: Đường Tỉnh 843, TT. Sa Rài\n`;
        prompt += `  - Quán ăn gia đình Tư Lùn 2: QL30, An Phước, Tân Hồng\n`;
        prompt += `  - Bánh xèo miền Tây: Đường Tỉnh 843, TT. Sa Rài\n`;
        prompt += `  - Cháo lòng Ông Mập: Chợ Sa Rài, TT. Sa Rài\n`;
        prompt += `  - Quán cơm chay Thiện Duyên: Nguyễn Huệ, TT. Sa Rài\n`;
        prompt += `  - Quán cháo cá lóc rau đắng: Đường Tỉnh 843, TT. Sa Rài\n`;
        prompt += `  - Lẩu mắm miền Tây: QL30, Tân Phước, Tân Hồng\n`;
        prompt += `  - Bò né 3 Ngon: Nguyễn Huệ, TT. Sa Rài\n`;
        prompt += `  - Gà nướng lu Bảy Đực: QL30, An Phước, Tân Hồng\n`;
        prompt += `  - Vịt quay A Lý: Chợ Sa Rài, TT. Sa Rài\n`;
        prompt += `  - Bún cá Châu Đốc: Đường Tỉnh 843, TT. Sa Rài\n`;
        prompt += `  - Nem nướng Nha Trang: Nguyễn Huệ, TT. Sa Rài\n`;
        prompt += `  - Quán ốc đêm: Chợ Sa Rài, TT. Sa Rài\n`;
        prompt += `  - Bánh canh ghẹ: QL30, TT. Sa Rài\n`;
        prompt += `  - Cơm tấm Sườn Bì Chả: Nguyễn Huệ, TT. Sa Rài\n`;
        prompt += `  - Lẩu Thái Tom Yum: Đường Tỉnh 843, TT. Sa Rài\n`;
        prompt += `  - Quán dê núi 79: QL30, An Phước, Tân Hồng\n`;
        prompt += `  - Bánh mì chảo: Nguyễn Huệ, TT. Sa Rài\n`;
        prompt += `  - Bò tơ Củ Chi: QL30, Tân Phước, Tân Hồng\n`;
        prompt += `  - Cơm gà xối mỡ: Đường Tỉnh 843, TT. Sa Rài\n`;
        prompt += `  - Apaoma Coffee: Nguyễn Huệ, TT. Sa Rài, H. Tân Hồng\n`;
        prompt += `  - Hoa Sứ Cafe: QL30, TT. Sa Rài\n`;
        prompt += `  - The Coffee House Tân Hồng: Nguyễn Huệ, TT. Sa Rài\n`;
        prompt += `  - Milano Coffee: Đường Tỉnh 843, TT. Sa Rài\n`;
        prompt += `  - Cafe Bờ Kè: Bờ kè sông Sa Rài, TT. Sa Rài\n`;
        prompt += `  - Cafe Sân Vườn Út Tịch: QL30, An Phước, Tân Hồng\n`;
        prompt += `  - Trà sữa BoBaPoP: Nguyễn Huệ, TT. Sa Rài\n`;
        prompt += `  - Cafe Phố: Đường Tỉnh 843, TT. Sa Rài\n`;
        prompt += `  - Cafe 1985: Nguyễn Huệ, TT. Sa Rài\n`;
        prompt += `  - Cafe Acoustic Garden: QL30, Tân Phước, Tân Hồng\n`;
        prompt += `  - Trà chanh Bụi Phố: Bờ kè sông Sa Rài, TT. Sa Rài\n`;
        prompt += `  - Cafe Sala: Nguyễn Huệ, TT. Sa Rài\n`;
        prompt += `  - Quán Cà Phê Suối Nguồn: DH. Tân Thành, Thông Bình, Tân Hồng\n`;
        prompt += `  - Cafe Điểm Hẹn: Xã An Phước, Tân Hồng\n`;
        prompt += `  - Quán Nước Mía Vườn Cau: QL30, TT. Sa Rài\n`;
        prompt += `  - Quán Café Hữu Tâm: DH. Tân Thành, Thông Bình, Tân Hồng\n`;
        prompt += `  - Trà Sữa Boon Tea: Xã Tân Hộ Cơ, Tân Hồng\n`;
        prompt += `  - Quán cà phê Tân Kỷ: Xã An Phước, Tân Hồng\n`;
        prompt += `  - Quán cà phê Bòn Bon: Xã Tân Hộ Cơ, Tân Hồng\n\n`;

        prompt += `YÊU CẦU TỪ NGƯỜI DÙNG:\n`;
        prompt += `- Các chùa muốn đi: ${selectedTemples.join(', ')}.\n`;
        prompt += `- Khung thời gian: từ ${startTime} đến ${endTime}. LƯU Ý: ${startTime} là thời gian KHỞI HÀNH từ Sa Rài.\n`;
        prompt += `- Đặc điểm nhóm: ${audience}.\n`;

        if (audience === 'Nhóm có người lớn tuổi') {
            prompt += `- LƯU Ý ĐẶC BIỆT: Vì nhóm có người lớn tuổi, hãy tạo một lịch trình thật thong thả, tránh các hoạt động dày đặc, và có nhiều thời gian nghỉ ngơi hơn giữa các điểm đến.\n`;
        }
        
        if (includeFood) prompt += `- Yêu cầu thêm: Có ăn uống. Gợi ý một quán ăn cụ thể KÈM THEO ĐỊA CHỈ từ DANH SÁCH QUÁN ĂN/CÀ PHÊ đã cho. QUAN TRỌNG: Quán ăn phải gần nhất có thể với ngôi chùa vừa đi qua hoặc sắp tới.\n`;
        if (includeDrink) prompt += `- Yêu cầu thêm: Có ghé quán nước/cafe. Gợi ý một quán cụ thể KÈM THEO ĐỊA CHỈ từ DANH SÁCH QUÁN ĂN/CÀ PHÊ đã cho. QUAN TRỌNG: Quán cafe phải gần nhất có thể với ngôi chùa vừa đi qua hoặc sắp tới.\n`;
        if (includeStay) prompt += `- Yêu cầu thêm: Có nghỉ lại qua đêm. Gợi ý một nhà nghỉ/khách sạn cụ thể tại huyện Tân Hồng KÈM THEO ĐỊA CHỈ (chỉ thêm nếu khung thời gian hợp lý).\n`;
        
        prompt += `\nNHIỆM VỤ CỐT LÕI: Dựa vào các chùa người dùng đã chọn và vị trí của chúng, hãy sắp xếp thứ tự các điểm đến để tạo ra một LỘ TRÌNH DI CHUYỂN TỐI ƯU NHẤT, tiết kiệm thời gian nhất, bắt đầu từ Trung tâm TT. Sa Rài.\n`;

        prompt += `\nQUY TẮC ĐỊNH DẠNG (CỰC KỲ QUAN TRỌNG):\n`;
        prompt += `- Hỗ trợ định dạng: *văn bản in nghiêng* và _văn bản gạch chân_.\n`;
        prompt += `- Định dạng mỗi mục trên một dòng: **Giờ** Emoji - Mô tả hoạt động tại [[Tên địa điểm - Địa chỉ]].\n`;
        prompt += `- Ví dụ MẪU:\n`;
        prompt += `  **07:00** 🚗 - Khởi hành từ _Trung tâm Sa Rài_.\n`;
        prompt += `  **08:00** 🙏 - Viếng chùa tại [[Chùa Phước Thiện - Công Tạo, Bình Phú, Tân Hồng, Đồng Tháp]].\n`;
        prompt += `  **12:00** 🍚 - Dùng bữa trưa. *Gợi ý: thử món đặc sản địa phương* tại [[Quán Cơm A - 123 đường Nguyễn Huệ, TT. Sa Rài, Tân Hồng, Đồng Tháp]].\n`;
        prompt += `  **17:00** ✅ - Kết thúc chuyến đi.\n`;
        prompt += `- Với các chùa, PHẢI dùng đúng tên và địa chỉ trong phần DỮ LIỆU BẮT BUỘC SỬ DỤNG.\n`;
        prompt += `- Nếu hoạt động không có địa điểm cụ thể (ví dụ: 'Khởi hành' hoặc 'Kết thúc chuyến đi'), thì không cần thêm phần 'tại [[...]]'.`;


        const apiKey = "AIzaSyAPinf6FjtKqn4WNfJ892W3kuiq4yIBgAQ";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const payload = { contents: [{ parts: [{ text: prompt }] }] };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API error! status: ${response.status}`);
            const result = await response.json();
            const itineraryText = result.candidates[0].content.parts[0].text;
            parseAndRenderItinerary(itineraryText);
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            resultDiv.innerHTML = `<p class="text-center text-red-500">Đã có lỗi xảy ra khi tạo lịch trình. Vui lòng thử lại sau.</p>`;
        } finally {
            loadingDiv.classList.add('hidden');
        }
    }
    
    function populateTimeOptions() {
        const startTimeSelect = document.getElementById('start-time');
        const endTimeSelect = document.getElementById('end-time');
        for (let i = 5; i <= 22; i++) {
            const hour = i.toString().padStart(2, '0');
            const optionStart = document.createElement('option');
            optionStart.value = i;
            optionStart.textContent = `${hour}:00`;
            startTimeSelect.appendChild(optionStart);

            const optionEnd = document.createElement('option');
            optionEnd.value = i;
            optionEnd.textContent = `${hour}:00`;
            endTimeSelect.appendChild(optionEnd);
        }
        // Set default values
        startTimeSelect.value = '7';
        endTimeSelect.value = '17';
    }

    // Initial setup
    document.addEventListener('DOMContentLoaded', () => {
        populateTimeOptions();
        lucide.createIcons();
    });
</script>

</body>
</html>


